# UBIRCH client (go)

The UBIRCH client provides signature and chaining services to seal original data generated on-premise. It takes care of
 packaging the hashed data, signing the package into the *UBIRCH PROTOCOL PACKET (UPP)* and sending it to the UBIRCH
 backend for storage, anchoring in the blockchain, and as a source for verification requests.
 
The original data must be stored in a customer database to be able to execute verification requests at a later stage.
 UBIRCH does not store any original sensitive data!
 
UPP data is sent to the UBIRCH client via HTTP requests. The client can receive either the original data as a JSON data
 package which will be formatted and hashed (SHA256) within the client, or the binary representation of a hash that is directly
 added to the UPP.

### Docker
The UBIRCH client is provided as a docker image that can be configured and run on any system that can run docker (Intel/AMD64 or ARM64 architecture).
 
Docker Hub Address: [ubirch/ubirch-client](https://docker.hub/ubirch/ubirch-client:stable) (multi-architecture image)

### Requirements
- System based on Intel/AMD64 or ARM
- Docker installation
- Space to store last used signatures and key material, either:
    - disk space, mounted into the docker pod, or 
    - as SQL database
- Possibility to send a HTTP request to UBIRCH.com domains
- A unique identifier (UUID) registered with the UBIRCH console
- A corresponding authorization token (acquired via UBIRCH console)
- A password for the client’s key store
- (OPTIONAL) a private ECDSA (ecdsa-prime256v1) key registered with the unique identifier
    *(otherwise a new key is generated by the client itself and registered with the UBIRCH backend)*

### Configuration
The client may be configured using a configuration file (`config.json`) or by using environment variables passed to the docker executable.

One client is able to handle multiple cryptographic identities (i.e. for multiple LAN based devices). The UUIDs for
 these devices must be declared in the configuration file together with their respective authentication token.

#### File Based Configuration 
`config.json`:
```
{
  "devices": {
    "<UUID>": "<ubirch backend auth token>"
  },
  "secret": "<16 byte secret used to encrypt the key store (base64 encoded)>",
  "DSN": "<optional data source name for database>",
  "staticUUID": <boolean, defaults to ‘false’>,
  "env": "<ubirch backend environment, defaults to “prod”>"
}
```
(See [example_config.json](main/example_config.json) for an example.)

#### Environment Based Configuration
```
export UBIRCH_DEVICES=’{"<UUID>":"<ubirch backend auth token>"}’
export UBIRCH_SECRET="<16 byte secret used to encrypt the key store  (base64 encoded)>"
export UBIRCH_DSN="<optional data source name for database>"
export UBIRCH_STATICUUID=<boolean, defaults to ‘false’>
export UBIRCH_ENV="<ubirch backend environment, defaults to 'prod'>"
```
(See [example.env](main/example.env) for an example.)

The client will first look for the `UBIRCH_DEVICES` env variable and load the configuration from the environment
 variables if it exists. If it is unset or empty, and the `config.json` file exists in the working directory, the
 configuration will be read from the file.
 
The only two mandatory configurations are the `devices`-map, which maps device UUIDs to their authentication token, and
 the 16 byte base64 encoded secret used to encrypt the key store. The other configuration parameters have default values.

If no DSN is set, the client will create a file `protocol.json` (and `protocol.json.bck`) locally in the working
 directory to store keys, key certificates and last signature.

For development, the reference to “prod” may be replaced by “demo”, which is a test system that works like the
 production environment, but stores data only in a blockchain test net.
 
#### How to acquire the ubirch backend token
- Open https://console.prod.ubirch.com/ or https://console.demo.ubirch.com/ and register a new user.
- Click on “Things” and then the green “ADD NEW DEVICE” button.
- Enter a UUID for your client and add a description, like “ubirch Lab Client”
- Click on “REGISTER DEVICE” and then “GO TO YOUR THINGS OVERVIEW”
- Click on your newly registered Thing.
- Copy the password (which looks like a UUID) as the ubirch backend token.

### Run Client in Docker container
To start the multi-arch Docker image, run:
```
docker pull ubirch/ubirch-client:stable
docker run -v $(pwd)/:/data/ ubirch/ubirch-client:stable .
```
The docker image mounts the current directory into the /data/ path to load and store information.

### Interface Description
The UBIRCH client provides two HTTP endpoints for both original data that is hashed by the client, and direct hash injection.

| Method | Path | Content-Type | Description |
|--------|------|--------------|-------------|
| POST | `/<UUID>` | `application/json` | JSON data package |
| POST | `/<UUID>/hash` | `application/octet-stream` | hash (binary) |

To access both endpoints the http-client must send an authorization token with the request header that is unique to the 
UUID used in the request. Without it, the client won’t accept the request:

| `X-Auth-Token:` | `ubirch backend token related to <UUID>` |
|-----------------|------------------------------------------| 

Response codes indicate the successful delivery of the UPP to UBIRCH. Any code other than 200 should be considered a
 failure. The client does not retry itself. A good approach to handle errors is to add a flag to the original data
 storage that indicates whether or not the UBIRCH blockchain anchoring was successful and retry at a later point if
 necessary.


## Install

A `Makefile` is provided to aid compiling and creating an executable for
the target architecture, it supports building x86 and ARM binaries, as well
as amd64 and ARM docker images.
If you want to use a database instead of local files, make sure
to apply the [database schema](main/schema.sql), as the application will
not create it itself on first run.


* build for ARM: run `make`
* copy `start.sh`, `main/ubirch-client-go`, and the `config.json` the target machine
* run `screen ./start.sh` (if it fails, use root or fix screen)
  - to exit screen presse `Ctrl-a d`
  - to reattach to the session, run `screen -R`

The output looks somewhat like this (started and stopped after first packet):
<details>
  <summary>Click to expand!</summary>

  ```
    2020/04/10 17:20:39 ubirch Golang client (v2.0.0, build=local)
    2020/04/10 17:20:39 loading configuration from file
    2020/04/10 17:20:39 loaded protocol context: 1 certificates, 0 signatures
    2020/04/10 17:20:43 64ea87f4-cfc4-4567-8bd1-0b4c15eaf55e: signer received request
    2020/04/10 17:20:43 64ea87f4-cfc4-4567-8bd1-0b4c15eaf55e: hash: eM6mQxRodjmGv4WGl++OpBGDNUP+jjL6by6xyW/wnRI= (78cea6431468763986bf858697ef8ea411833543fe8e32fa6f2eb1c96ff09d12)
    2020/04/10 17:20:43 64ea87f4-cfc4-4567-8bd1-0b4c15eaf55e: UPP: 9623c41064ea87f4cfc445678bd10b4c15eaf55ec4400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c42078cea6431468763986bf858697ef8ea411833543fe8e32fa6f2eb1c96ff09d12c4400cb1cd9f54aefac2dd2fc593f8114735fadc4ef10abd93af7735f00a58f60f6fd8619421c3d0cde66585bc7c784611b0b0343551f9e957205b250c35ff0fd197
    2020/04/10 17:20:45 64ea87f4-cfc4-4567-8bd1-0b4c15eaf55e: response: (200) �#��<x�"�DA�х�6Ԇ��@��message�your request has been submitted�@�_� ��O ���f�`aT��s��ly<|��u�`\�9�l�s4��Fu�����| E�ؾq��
    2020/04/10 17:21:24 shutting down after receiving: interrupt
    2020/04/10 17:21:24 shutting down http server
    2020/04/10 17:21:24 finishing signer
  ```

</details>


## Copyright

```
Copyright (c) 2019 ubirch GmbH

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

Authors: Matthias L. Jugel, Waldemar Grünwald, Roxana Meixner