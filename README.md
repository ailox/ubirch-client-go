# UBIRCH client (go)

The UBIRCH client provides signature and chaining services to seal original data generated on-premise. It takes care of
 packaging the hashed data into a chained *UBIRCH PROTOCOL PACKET ("UPP")*, signing the package and sending it to the 
 UBIRCH backend for storage, anchoring in the blockchain, and as a source for verification requests.
 
The original data must be stored in a customer database to be able to execute verification requests at a later stage.
 UBIRCH does not store any original sensitive data!
 
UPP data is sent to the UBIRCH client via HTTP requests. The client can receive either the original data as a JSON data
 package which will be formatted and hashed (SHA256) by the client, or the binary representation of a hash that is directly
 added to the UPP.
 
The UBIRCH client stores its signing keys and the signature of the last UPP persistently to ensure an intact chain even
 after a restart.

### Dockerized UBIRCH client
The UBIRCH client is provided as a docker image that can be configured and run on any system that can run docker (Intel/AMD64 or ARM64 architecture).
 
Docker Hub Address: [ubirch/ubirch-client](https://docker.hub/ubirch/ubirch-client:stable) (multi-architecture image)

[Jump to Quick Start](#quick-start)

### Requirements
- System based on Intel/AMD64 or ARM
- Docker installation
- Space to store last used signatures and key material, either:
    - disk space, mounted into the docker pod, or 
    - as SQL database
- Possibility to send a HTTP request to UBIRCH.com domains
- A unique identifier (UUID) registered with the UBIRCH console
- A corresponding authorization token (acquired via UBIRCH console)
- A password for the client’s key store
- (OPTIONAL) a private ECDSA (ecdsa-prime256v1) key
    *(otherwise a new key is generated by the client itself)*

### Configuration
The client may be configured using a configuration file (`config.json`) or by using environment variables
 that can be passed to the docker executable.

The client is able to handle multiple cryptographic identities (i.e. for multiple LAN based devices). The UUIDs for
 these devices must be declared in the configuration file together with their respective authentication token. Only
 requests from *known* UUIDs will be accepted by the client.

#### File Based Configuration 
`config.json`:
```
{
  "devices": {
    "<UUID>": "<ubirch backend auth token>"
  },
  "secret": "<16 byte secret used to encrypt the key store (base64 encoded)>",
  "DSN": "<optional data source name for database>",
  "staticUUID": <boolean, defaults to ‘false’>,
  "env": "<ubirch backend environment, defaults to “prod”>"
}
```
(See [example_config.json](main/example_config.json) for an example.)

#### Environment Based Configuration
```
export UBIRCH_DEVICES=’{"<UUID>":"<ubirch backend auth token>"}’
export UBIRCH_SECRET="<16 byte secret used to encrypt the key store  (base64 encoded)>"
export UBIRCH_DSN="<optional data source name for database>"
export UBIRCH_STATICUUID=<boolean, defaults to ‘false’>
export UBIRCH_ENV="<ubirch backend environment, defaults to 'prod'>"
```
(See [example.env](main/example.env) for an example.)

The client will first look if the `UBIRCH_DEVICES` env variable exists and load the configuration from the environment
 variables in that case. If the `UBIRCH_DEVICES` env variable is not set or empty, and the `config.json`-file exists in 
 the working directory, the configuration will be loaded from the file. If neither exist, the client will abort and exit.
 
The only two mandatory configurations are 
- the `devices`-map, which maps device UUIDs to their authentication token 
(see [here](#how-to-acquire-the-ubirch-backend-token) how to acquire the authentication token),
- and the 16 byte base64 encoded `secret`, which is used to encrypt the key store.
 
 All other configuration parameters have default values:

- The `DSN` (*data source name*) can be used to connect the client to a SQL database for storing keys and last signatures 
persistently. If no DSN is set, the client will create a file `protocol.json` (and `protocol.json.bck`) locally in the 
working directory.

    If you want to use a SQL database instead of local files to store keys and last signatures persistently, make sure
 to apply the [database schema](main/schema.sql), as the application will not create it itself on first run.
 
- The `staticUUID`-flag may be used to disable dynamic key generation. The default value for this flag is `false`, which
 means the client will per default generate a new ECDSA (ecdsa-prime256v1) key pair if it receives a request from a UUID
 without a corresponding signing key in the keystore. An alternative to dynamic key generation is to inject signing keys
 as a map in the form...
    
    ```{"<UUID>": "<ecdsa-prime256v1 private key (base64 encoded)>"}```
    
    ...either as env variable `UBIRCH_KEY_MAP` or in a file `keys.json`.
    Either way (dynamically generated or injected) the client will register the public key at the UBIRCH key service and
    store the keys persistently in the encrypted keystore.

- The `env` configuration refers to the UBIRCH backend environment. The default value is `prod`, which is the
 production environment. For development, the reference to “prod” may be replaced by “demo”, which is a test system
 that works like the production environment, but stores data only in a blockchain test net.
 
#### How to acquire the ubirch backend token
- Register at the **UBIRCH web UI**: https://console.prod.ubirch.com/ or https://console.demo.ubirch.com/
- Go to **Things** (in the menu on the left) and click on `+ ADD NEW DEVICE`
- Enter your device UUID to the **ID** field. You can also add a description for your device, if you want. Then click on `register`. 
- Your device should now show up under **Your Things**-overview. Click on it and copy the "password" (which looks like a UUID) as the ubirch backend token.

### Run Client in Docker container
To start the multi-arch Docker image on any system, run:
```
docker pull ubirch/ubirch-client:stable
docker run -v $(pwd)/:/data/ --network=host ubirch/ubirch-client:stable .
```
The docker image mounts the current directory (`$(pwd)`) into the */data/* path to load the configuration
 and store keys and last signatures (if no DSN is set). You can also pass an absolute path instead of `$(pwd)`.

### Interface Description
The UBIRCH client provides two HTTP endpoints for both original data that will be hashed by the client,
 and direct data hash injection.

| Method | Path | Content-Type | Description |
|--------|------|--------------|-------------|
| POST | `/<UUID>` | `application/json` | JSON data package |
| POST | `/<UUID>/hash` | `application/octet-stream` | hash (binary) |

To access either endpoint an authorization token, which corresponds to the `UUID` used in the request,
 must be sent with the request header. Without it, the client won’t accept the request:

| `X-Auth-Token:` | `ubirch backend token related to <UUID>` |
|-----------------|------------------------------------------| 

Response codes indicate the successful delivery of the UPP to the UBIRCH backend.
 Any code other than `200` should be considered a failure. The client does not retry itself.
 A good approach to handle errors is to add a flag to the original data storage that indicates whether the
 UBIRCH blockchain anchoring was successful and retry at a later point if necessary.

## Quick Start
1. First, you will need a unique id (UUID) identifying your GoClient, an authorization token, and a 16 byte secret:
    1. Generate a UUID. On Linux simply enter `uuidgen` in your terminal. Alternatively, you can use an online tool.
    2. Get your auth token from the [UBIRCH Thing API](https://console.demo.ubirch.com/):
        - Go to **Things** (in the menu on the left) and click on `+ ADD NEW DEVICE`
        - Enter your UUID to the **ID** field, add a description for your device and click on `register`. 
        - In the **Your Things**-overview, click on your device and copy from the apiConfig the value of the password. That's your token.
    3. To generate a 16 byte secret in base64 format enter in a Linux terminal `head -c 16 /dev/urandom | base64`.
    Alternatively, you can encode 16 ASCII characters in an online base64 converter. This secret is used to encrypt the key  store.

2. Create a file `config.json` in your desired working directory with the following content:
    ```
    {
      "devices": {
        "<YOUR_UUID>": "<YOUR_AUTH_TOKEN>"
      },
      "secret": "<YOUR_16_BYTE_SECRET(base64 encoded)>",
      "env": "demo"
    }
    ```
    - Replace `<UUID>` with your UUID from step 1.i.
    - Replace `<ubirch backend auth token>` with your authorization token from step 1.ii.
    - Replace `<16 byte secret used to encrypt the key store (base64 encoded)>` with your 16 byte secret from step 1.iii.
    > Make sure you leave the quotes! [Here](main/example_config.json) is an example of how it should look like.

3. Run the dockerized UBIRCH client. For this step, you will need to have Docker (https://www.docker.com/) installed on your computer. Then just enter the following two lines in your working directory:
    ```
    docker pull ubirch/ubirch-client:stable
    docker run -v $(pwd)/:/data/ --network=host ubirch/ubirch-client:stable .
    ```
    You should see a console output like this:
    ```
    2020/04/14 13:40:54 UBIRCH client (v2.0.0, build=local)
    2020/04/14 13:40:54 loading configuration from file (config.json)
    2020/04/14 13:40:54 loaded protocol context: 0 certificates, 0 signatures
    ```
    That means the client is running and ready!
    
4. The client is now listening for HTTP POST requests on port `8080`. You can either...
   - send JSON data to the `/<UUID>`-endpoint with `Content-Type: application/json`-header, or 
   - send hashes to the `/<UUID>/hash`-endpoint with `Content-Type: application/octet-stream`-header. 
   
   Also, set the `X-Auth-Token`-header with your ubirch backend auth token.

   Here is an example of how a request to the client would look like using `CURL`:
   ```
   curl -H "X-Auth-Token: <YOUR_AUTH_TOKEN>" -H "Content-Type: application/json" -d '{"id": "605b91b4-49be-4f17-93e7-f1b14384968f", "ts": 1585838578, "temperature": 23.6}' localhost:8080/<YOUR_UUID> -i -s
   ```
   > Insert `<YOUR_AUTH_TOKEN>` and `<YOUR_UUID>` and a body to the request. Ensure that the body each time has a unique content, as the Go Client will generate a hash of it that is used as the unique identifier of your request in the ubirch backend! 
   
   If your request was successful, you'll get a `HTTP/1.1 200 OK` response.
   
   The client output should look somewhat like this:
   ```
   2020/04/14 13:46:34 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: signer received request
   2020/04/14 13:46:34 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: generating new key pair
   2020/04/14 13:46:35 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: registering public key at key service
   2020/04/14 13:46:35 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: CERT: {"pubKeyInfo":{"algorithm":"ecdsa-p256v1","created":"2020-04-14T22:46:35.008Z","hwDeviceId":"8a70ad8b-a564-4e58-9a3b-224ac0f0153f","pubKey":"mSmvMcuI9FeRWiSRC4NO7Xuz8YpK2QT+GWf91m4braTNtwHC3pNLJg+HjsipxcF0gX94bNycPmaEf5DFIkeslA==","pubKeyId":"mSmvMcuI9FeRWiSRC4NO7Xuz8YpK2QT+GWf91m4braTNtwHC3pNLJg+HjsipxcF0gX94bNycPmaEf5DFIkeslA==","validNotAfter":"2021-04-14T22:46:35.008Z","validNotBefore":"2020-04-14T22:46:35.008Z"},"signature":"WeJoAVJTgQD5XhO8MfFk0H9kG42taowMVAK7Jtx/H5ebU6eGmT4BixGOUroHPUoEDGlteMp39lVdeLd53YmIGw=="}
   2020/04/14 13:46:35 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: key registration successful
   2020/04/14 13:46:35 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: hash: Y0I9f0GrIj4V6RGh6FW4IzCLj/bQa8uMpLjYtr7OFQk=
   2020/04/14 13:46:35 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: UPP: 9623c41064ea87f4cfc445678bd10b4c15eaf55ec4400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c42063423d7f41ab223e15e911a1e855b823308b8ff6d06bcb8ca4b8d8b6bece1509c440719302929764228c4e891b60f413b88b6581c004257eb8c668bb84d42ff3dd345eea2ec3d338875188db1d15a9ed55ac8a7dde39904eb2874b4b3a2290466aa5
   2020/04/14 13:46:37 8a70ad8b-a564-4e58-9a3b-224ac0f0153f: response: (200) �#��<x�"�DA�х�6Ԇ��@��message�your request has been submitted�@�_���O	���f�`aT��s��ly<|��u�`\�9�l�s4��Fu�����| E�ؾq��
   ```
   > Take note of the hash!
   
5. To stop the client, press `ctrl` + `c`.
   
6. You can verify that the hash of your data/request was received and chained in the UBIRCH backend
   - with CURL: `curl -d '<YOUR_HASH>' https://verify.demo.ubirch.com/api/upp/verify`, or
   - in the [UBIRCH Things API](https://console.demo.ubirch.com/verification/graph)
   
 More information on the services and functionalities of the ubirch backend you can find here: https://developer.ubirch.com/

## Copyright

```
Copyright (c) 2019 ubirch GmbH

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```

Authors: Matthias L. Jugel, Waldemar Grünwald, Roxana Meixner
